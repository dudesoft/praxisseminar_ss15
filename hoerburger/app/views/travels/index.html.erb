<div id="map"></div>

<script type="text/javascript">
  setTravelPath();

  function setTravelPath() {
    var locationLayer = L.layerGroup();
    var travelLayer = L.layerGroup();

    <% @travels.each do |travel| %>
    var locations = [];
    <% travel.locations.each do |location| %>
    locations.push([<%= location.latitude %>, <%= location.longitude %>]);
    new L.marker(locations[locations.length - 1], {icon: locationIcon}).addTo(locationLayer);
    <% end %>
    var poly = new L.Polyline(locations, {
      color: 'red',
      weight: 3,
      opacity: 0.5,
      smoothFactor: 1
    }).addTo(locationLayer);
    if (locations.length > 0) {
      createTravelMarker(poly).addTo(travelLayer);
    }
    <% end %>

    var osmAttrib = 'Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
    var osm = new L.TileLayer('<%= MAPBOX_API %>',
        {
          minZoom: 3,
          maxZoom: 13,
          attribution: osmAttrib
        });

    var southWest = L.latLng(250, 250),
        northEast = L.latLng(-250, -250),
        bounds = L.latLngBounds(southWest, northEast);

    var map = L.map('map', {
      center: [28.635308, 77.22496],
      zoom: 8,
      layers: [osm, locationLayer],
      maxBounds: bounds
    });

    var baseLayers = {
      "Cities": locationLayer,
      "Travels": travelLayer
    };

    L.control.layers(baseLayers, null).addTo(map);
    //var p = L.polygon(locations);
  }

  function createTravelMarker(poly) {
    var marker = new L.marker(poly.getBounds().getCenter(), {icon: travelIcon}).bindPopup("Popup content");
    marker.on('mouseover', function (e) {
      this.openPopup();
    });
    return marker;
  }
</script>